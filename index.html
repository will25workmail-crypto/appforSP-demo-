<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Pipeline</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>

<body class="bg-gray-900 text-white min-h-screen">
  <div class="bg-gray-800 p-6 text-center text-3xl font-bold sticky top-0 z-10 shadow-lg">Sales Pipeline</div>

  <div class="space-y-8 px-4 pt-4 pb-32">
    <div><div class="bg-blue-600 p-4 text-center font-bold text-xl rounded-t-2xl">Chatbot Lead</div><div id="chatbot-lead" class="bg-white text-black rounded-b-2xl p-5 space-y-4"></div></div>
    <div><div class="bg-indigo-600 p-4 text-center font-bold text-xl rounded-t-2xl">Qualified</div><div id="qualified" class="bg-white text-black rounded-b-2xl p-5 space-y-4"></div></div>
    <div><div class="bg-purple-600 p-4 text-center font-bold text-xl rounded-t-2xl">Appt Set</div><div id="appt-set" class="bg-white text-black rounded-b-2xl p-5 space-y-4"></div></div>
    <div><div class="bg-green-600 p-4 text-center font-bold text-xl rounded-t-2xl">Showed</div><div id="showed" class="bg-white text-black rounded-b-2xl p-5 space-y-4"></div></div>
    <div><div class="bg-yellow-600 p-4 text-center font-bold text-xl rounded-t-2xl">Wrote Up</div><div id="wrote-up" class="bg-white text-black rounded-b-2xl p-5 space-y-4"></div></div>
    <div><div class="bg-orange-600 p-4 text-center font-bold text-xl rounded-t-2xl">Sold</div><div id="sold" class="bg-white text-black rounded-b-2xl p-5 space-y-4"></div></div>
    <div><div class="bg-teal-600 p-4 text-center font-bold text-xl rounded-t-2xl">Delivered</div><div id="delivered" class="bg-white text-black rounded-b-2xl p-5 space-y-4"></div></div>
    <div><div class="bg-red-700 p-4 text-center font-bold text-xl rounded-t-2xl">Lost</div><div id="lost" class="bg-white text-black rounded-b-2xl p-5 space-y-4"></div></div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzleiQlkUV9lQ4jo0jDeY2Wi2hqazb25c6_1gtC2faim5rSYBIRfbBRErKopGOM6fnVEg/exec'

    async function loadLeads() {
      try {
        const res = await fetch(SCRIPT_URL + '?t=' + Date.now())
        const leads = await res.json()
        document.querySelectorAll('[id]').forEach(c => c.innerHTML = '')

        leads.forEach((l, i) => {   // ← THIS WAS BROKEN BEFORE, NOW FIXED
          const card = document.createElement('div')
          card.dataset.row = i + 2
          card.className = 'bg-gray-50 border border-gray-200 p-5 rounded-2xl shadow-md cursor-move'

          const name = l.Name || l['C1: Name'] || '—'
          const email = l.Email || l['B1: Email'] || ''
          const phone = l.Phone || l['D1: Phone'] || ''
          const vehicle = l['Vehicle Type'] || l['G1: Vehicle Type'] || ''
          const budget = l.Budget || l['E1: Budget'] || ''
          const timeline = l.Timeline || l['F1: Timeline'] || ''
          const isHot = (l['Lead Type'] || l['A1: Lead Type'] || '').toLowerCase().trim() === 'hot'

          card.innerHTML = `
            <div class="font-bold text-xl">${name}</div>
            <div class="text-gray-600 text-sm mt-1">${email} • ${phone}</div>
            <div class="font-semibold mt-3 text-lg">${vehicle}</div>
            <div class="text-sm mt-1">Budget: $${budget} • ${timeline}</div>
            <div class="mt-4 inline-block px-5 py-2 rounded-full text-white font-bold ${isHot ? 'bg-red-600' : 'bg-orange-500'}">
              ${isHot ? 'HOT' : 'WARM'}
            </div>
          `

          const stage = (l.Stage || l.stage || 'chatbot-lead').toLowerCase()
          const target = stage.includes('appt') ? 'appt-set' :
                         stage.includes('qualified') ? 'qualified' :
                         stage.includes('show') ? 'showed' :
                         stage.includes('wrote') ? 'wrote-up' :
                         stage.includes('sold') ? 'sold' :
                         stage.includes('delivered') ? 'delivered' :
                         stage.includes('lost') ? 'lost' :
                         'chatbot-lead'

          document.getElementById(target).appendChild(card)
        })

        // Re-activate drag & drop
        const stages = ['chatbot-lead','qualified','appt-set','showed','wrote-up','sold','delivered','lost']
        stages.forEach(s => new Sortable(document.getElementById(s), {
          group: 'pipeline',
          animation: 150,
          onEnd: e => {
            const row = e.item.dataset.row
            const newStage = e.to.id
            fetch(`${SCRIPT_URL}?row=${row}&stage=${newStage}`, { method: 'POST' })
          }
        }))
      } catch (e) {
        console.error(e)
      }
    }

    loadLeads()
    setInterval(loadLeads, 10000)
  </script>
</body>
</html>
